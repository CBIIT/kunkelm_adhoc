<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"      
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                template="/webpages/templates/ui.xhtml">


    <ui:define name="title">
        <h:outputText value="Active List Table View" />
    </ui:define>

    <ui:define name="instructions"/>

    <ui:define name="export"> 
        <p:commandButton ajax="false" value="Export to Excel">
            <p:dataExporter type="xls"  
                            target="activeListTbl" 
                            fileName="activeListTable" />  
        </p:commandButton>

        <p:commandButton ajax="false" value="Export as CSV">  
            <p:dataExporter type="csv" 
                            target="activeListTbl" 
                            fileName="activeListTable" />  
        </p:commandButton> 

        <p:commandButton value="Export Structures as Image"
                         type="button"
                         ajax="false"
                         onclick="structuresAsGridImage()"/>

    </ui:define>

    <ui:define name="alternate"/>

    <ui:define name="content title">
        <h:outputText value="Table View #{listManagerController.listManagerBean.activeList.listName} with #{fn:length(listManagerController.listManagerBean.activeList.cmpdListMembers)} ListMembers" />  
    </ui:define>

    <ui:define name="content">

        <!-- ensures that the filteredValues are reset whenever the page loads/reloads -->    
        <p:remoteCommand actionListener="#{listManagerController.handleSynchronizeFilters()}"
                         autoRun="true"/>

        <p:menubar>

            <p:menuitem action="#{listContentController.performConnectToLandingSpotfire()}"
                        value="Landing Spotfire on Selected"
                        onstart="PF('resolvingBUI').show();"
                        oncomplete="PF('resolvingBUI').hide();"
                        style="width: 100%;"/>

            <p:menuitem action="#{listContentController.performDeleteFromActiveList()}"
                        value="Delete Selected from List"
                        onstart="PF('deletingBUI').show();"
                        oncomplete="PF('deletingBUI').hide();"
                        style="width: 100%;">
                <f:setPropertyActionListener value="#{listManagerController.listManagerBean.activeList}"   
                                             target="#{listContentController.targetList}" />  
            </p:menuitem>

            <p:menuitem action="#{listContentController.performCreateNewListFromSelectedListMembers()}"
                        value="Create New List from Selected"
                        onstart="PF('appendingBUI').show();"
                        oncomplete="PF('appendingBUI').hide();"
                        style="width: 100%;" />

            <f:facet name="options">
                <p:outputLabel for="listNameAutoComp" value="List name:"/>     
                <p:autoComplete id="listNameAutoComp"
                                converter="#{cmpdListConverter}"
                                dropdown="false"                                 
                                emptyMessage="No matches"
                                placeholder="Start typing for possible matches"
                                scrollHeight="150"
                                minQueryLength="3"                                    
                                completeMethod="#{listManagerController.completeListName}"                        
                                value="#{listContentController.targetList}">
                </p:autoComplete>   
            </f:facet>

        </p:menubar>

        <p:panelGrid columns="1">

            <p:panel header="List Anchor Structure"
                     rendered="#{sessionController.configurationBean.showAnchor and !empty listManagerController.listManagerBean.activeList.anchorSmiles}">

                <h:outputText value="anchorSmiles: ${listManagerController.listManagerBean.activeList.anchorSmiles}"/>

                <br/>

                <p:graphicImage alt="Chemical Structure of List Anchor"
                                width="#{sessionController.configurationBean.strcDim}" 
                                height="#{sessionController.configurationBean.strcDim}"
                                styleClass="anchorStructure"
                                url='#{sessionController.configurationBean.getSmilesStrcUrl(listManagerController.listManagerBean.activeList.anchorSmiles)}'>              
                </p:graphicImage>

            </p:panel>

            <p:spacer height="20" width="100%"/>

            <p:dataTable  id="activeListTbl"
                          resizableColumns="true" 
                          draggableColumns="true"
                          tableStyle="width: auto;"                 
                          widgetVar="activeListTblWidgetVar"
                          var="listMember"                       
                          value="#{listManagerController.listManagerBean.activeList.cmpdListMembers}" 
                          rows="50"                        
                          paginator="true"
                          paginatorPosition="top"
                          currentPageReportTemplate="Page: {currentPage}/{totalPages} Records: {startRecord}-{endRecord} out of {totalRecords} filtered records"
                          paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown} rows per page"  
                          rowsPerPageTemplate="50,100,250,500,1000,2000"
                          selection="#{listManagerController.listManagerBean.selectedActiveListMembers}"
                          filteredValue="#{listManagerController.listManagerBean.filteredActiveListMembers}"
                          rowKey="#{listMember.id}"                              
                          sortMode="multiple"
                          rowIndexVar="rowIdx">  

                <c:set var="cmpd" value="#{listMember.cmpd}" />
                <c:set var="strc" value="#{listMember.cmpd.parentFragment.cmpdFragmentStructure}" />
                <c:set var="physchem" value="#{listMember.cmpd.parentFragment.cmpdFragmentPChem}" />
                <c:set var="biodat" value="#{listMember.cmpd.cmpdBioAssay}" />

                <f:facet name="header">                
                    <h:outputText value="List #{listManagerController.listManagerBean.activeList.listName} with #{fn:length(listManagerController.listManagerBean.activeList.cmpdListMembers)} Members"/>                    
                </f:facet>

                <p:column selectionMode="multiple" 
                          style="width:4%" 
                          exportable="false"/>

                <p:column headerText="Discreet" 
                          resizable="true">                                
                    <h:outputText value="#{cmpd.discreet}"/>
                </p:column>   

                <p:column headerText="NSC" 
                          resizable="true">                                
                    <h:outputText value="#{cmpd.nsc}"/>
                </p:column>   

                <p:column headerText="CONF" 
                          resizable="true"
                          sortBy="#{cmpd.conf}"
                          filterBy="#{cmpd.conf}"
                          filterMatchMode="contains">                                
                    <h:outputText value="#{cmpd.conf}"/>
                </p:column>   

                <p:column headerText="DIST" 
                          resizable="true">                                
                    <h:outputText value="#{cmpd.distribution}"/>
                </p:column>   

                <p:column headerText="NSCCmpdType"
                          sortBy="#{cmpd.nscCmpdType}"
                          filterBy="#{cmpd.nscCmpdType}"
                          filterMatchMode="contains">
                    <h:outputText value="#{cmpd.nscCmpdType}"/>
                </p:column>   

                <p:column headerText="Parent - Click for Details" 
                          resizable="true">

                    <p:commandLink update=":datasystemForm:ListMemberDetailsDialogPanel" 
                                   oncomplete="PF('listMemberDetailDlg').show();" 
                                   title="View Detail">
                        <p:graphicImage alt="Chemical Structure of Parent Fragment"
                                        width="#{sessionController.configurationBean.strcDim}" 
                                        height="#{sessionController.configurationBean.strcDim}"
                                        styleClass="parentStructure"
                                        url='#{sessionController.configurationBean.getCmpdStrcUrl(listMember.cmpd, listManagerController.listManagerBean.activeList.anchorSmiles)}'>              
                        </p:graphicImage>
                        <f:setPropertyActionListener value="#{listMember}"   
                                                     target="#{listManagerController.listManagerBean.selectedActiveListMember}" />  
                    </p:commandLink>

                </p:column>

                <p:column headerText="Fragments" rendered="#{sessionController.configurationBean.showFrags}">

                    <p:dataGrid columns="1" 
                                value="#{cmpd.cmpdFragmentSmilesStrings}" 
                                var="fragSmiles">
                        <p:graphicImage alt="Chemical Structure of Compound Fragment"
                                        width="#{sessionController.configurationBean.strcDim}" 
                                        height="#{sessionController.configurationBean.strcDim}"
                                        styleClass="fragmentStructure"
                                        url='#{sessionController.configurationBean.getSmilesStrcUrl(fragSmiles)}'>              
                        </p:graphicImage>
                    </p:dataGrid>
                </p:column>    

                <p:column headerText="mtxt"  
                          sortBy="#{cmpd.cmpdAnnotation.mtxt}"
                          filterBy="#{cmpd.cmpdAnnotation.mtxt}"
                          filterMatchMode="contains"
                          width="50" 
                          style="text-wrap: normal; white-space: normal;">
                    <h:outputText value="#{cmpd.cmpdAnnotation.mtxt}"/>
                </p:column>

                <p:column headerText="pseudo atoms">
                    <h:outputText value="#{cmpd.cmpdAnnotation.pseudoAtoms}"/>
                </p:column>

                <!-- webpage display, exportable="false" -->

                <p:columns resizable="true"  
                           exportable="false"
                           width="50"
                           value="#{sessionController.configurationBean.cmpdColumns}" 
                           var="column" 
                           columnIndexVar="colIndex" 
                           sortBy="#{cmpd[column.property]}" 
                           filterBy="#{cmpd[column.property]}"
                           filterFunction="#{customFilter.customFilter}">

                    <f:facet name="header">                        
                        <h:outputText value="#{column.header}" />
                    </f:facet>

                    <h:outputText rendered="#{column.property ne 'aliases' and column.property ne 'projects' and column.property ne 'plates'}"
                                  value="#{cmpd[column.property]}"/>

                    <p:dataList rendered="#{column.property eq 'aliases' or column.property eq 'projects' or column.property eq 'plates'}"
                                var="prop" 
                                value="#{cmpd[column.property]}"
                                rows="5" 
                                paginator="true"
                                paginatorPosition="top" 
                                paginatorAlwaysVisible="false"
                                currentPageReportTemplate="Page: {currentPage}/{totalPages} Records: {startRecord}-{endRecord} out of {totalRecords}"
                                paginatorTemplate="{CurrentPageReport} {PreviousPageLink} {NextPageLink}">

                        <h:outputText value="#{prop.length() gt 50 ? prop.substring(0,49).concat('...') : prop}" />
                    </p:dataList>

                </p:columns>

                <!-- exportable data, display: none; -->

                <p:columns style="display: none;"
                           resizable="true"  
                           value="#{sessionController.configurationBean.cmpdColumns}" 
                           var="column" 
                           columnIndexVar="colIndex" 
                           sortBy="#{cmpd[column.property]}" 
                           filterBy="#{cmpd[column.property]}">

                    <f:facet name="header">                        
                        <h:outputText value="#{column.header}" />
                    </f:facet>                      

                    <h:outputText value="#{cmpd[column.property]}"/>

                </p:columns>


                <p:columns resizable="true" 
                           value="#{sessionController.configurationBean.structureColumns}" 
                           var="column" 
                           columnIndexVar="colIndex" 
                           sortBy="#{strc[column.property]}" 
                           filterBy="#{strc[column.property]}">
                    <f:facet name="header">
                        <h:outputText value="#{column.header}" />
                    </f:facet>
                    <h:outputText value="#{strc[column.property]}" />
                </p:columns>


                <p:columns resizable="true" 
                           value="#{sessionController.configurationBean.physChemColumns}" 
                           var="column" 
                           columnIndexVar="colIndex" 
                           sortBy="#{physchem[column.property]}" 
                           filterBy="#{physchem[column.property]}">
                    <f:facet name="header">
                        <h:outputText value="#{column.header}" />
                    </f:facet>
                    <h:outputText value="#{physchem[column.property]}" />
                </p:columns>

                <p:columns resizable="true" 
                           value="#{sessionController.configurationBean.biodataColumns}" 
                           var="column" 
                           columnIndexVar="colIndex" 
                           sortBy="#{biodat[column.property]}" 
                           filterBy="#{biodat[column.property]}">
                    <f:facet name="header">
                        <h:outputText value="#{column.header}" />
                    </f:facet>
                    <h:outputText value="#{biodat[column.property]}" />
                </p:columns>

            </p:dataTable>

        </p:panelGrid>

    </ui:define>

</ui:composition>
