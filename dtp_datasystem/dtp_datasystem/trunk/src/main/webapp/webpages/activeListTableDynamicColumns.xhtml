<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"      
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                template="/webpages/templates/ui.xhtml">

  <ui:define name="content">

    <ui:remove><ui:include src="/webpages/templates/active_list_nav.xhtml"/></ui:remove>

    <ui:remove>

      <p:fieldset legend="Export All Data">  

        <p:commandButton ajax="false" value="Export to Excel">
          <p:dataExporter type="xls" 
                          target="activeListTbl" 
                          fileName="activeList_listId_#{listManagerController.activeList.cmpdListId}" />        
        </p:commandButton>

        <p:spacer width="20"/>

        <p:commandButton ajax="false" value="Export as CSV">  
          <p:dataExporter type="csv" 
                          target="activeListTbl" 
                          fileName="activeList_listId_#{listManagerController.activeList.cmpdListId}" />
        </p:commandButton> 

        <p:spacer width="20"/>

        <p:commandButton ajax="false" value="Export to Excel with Structure Images">
          <p:dataExporter type="xls" 
                          target="activeListTbl" 
                          postProcessor="#{listManagerController.postProcessXLS}"
                          fileName="activeList_listId_#{listManagerController.activeList.cmpdListId}" />        
        </p:commandButton>

        <p:spacer width="20"/>

        <p:commandButton onclick="structuresAsGridImage();" 
                         value="Image of bare structures as grid" /> 

      </p:fieldset>

      <p:spacer height="20" width="100%"/>

    </ui:remove>

    <p:panel rendered="${!empty listManagerController.activeList.anchorSmiles}">

      <h:outputText value="anchorSmiles: ${listManagerController.activeList.anchorSmiles}"/>

      <br/>

      <h:graphicImage alt="activeListAnchorSmiles"
                      width="200" height="200"
                      url='/StructureServlet?structureDim=200&amp;title=listAnchorSmiles&amp;smiles=#{applicationScopeBean.urlEncode(listManagerController.activeList.anchorSmiles)}'>              
      </h:graphicImage>

    </p:panel>

    <p:spacer height="20" width="100%"/>

    <p:accordionPanel>
      <p:tab title="Cmpd Parameters">
        <p:selectManyCheckbox id="cmpdGrid"
                              value="#{listManagerController.selectedCmpdParameters}" 
                              layout="grid" 
                              columns="5">
          <f:selectItems value="#{listManagerController.availableCmpdParameters}" 
                         var="cmpdParam" 
                         itemLabel="#{cmpdParam}" 
                         itemValue="#{cmpdParam}" />
        </p:selectManyCheckbox>
      </p:tab>
      <p:tab title="PChem Parameters">        
        <p:selectManyCheckbox id="physChemGrid"
                              value="#{listManagerController.selectedPChemParameters}" 
                              layout="grid" 
                              columns="5">
          <f:selectItems value="#{listManagerController.availablePChemParameters}" 
                         var="pChemParam" 
                         itemLabel="#{pChemParam}" 
                         itemValue="#{pChemParam}" />
        </p:selectManyCheckbox>
      </p:tab>
      <p:tab title="Structure Parameters">
        <p:selectManyCheckbox id="structureGrid"
                              value="#{listManagerController.selectedStructureParameters}" 
                              layout="grid" 
                              columns="5">
          <f:selectItems value="#{listManagerController.availableStructureParameters}" 
                         var="strucParam" 
                         itemLabel="#{strucParam}" 
                         itemValue="#{strucParam}" />
        </p:selectManyCheckbox>
      </p:tab>
      <p:tab title="BioData Parameters">
        <p:selectManyCheckbox id="bioDataGrid"
                              value="#{listManagerController.selectedBioDataParameters}" 
                              layout="grid" 
                              columns="5">
          <f:selectItems value="#{listManagerController.availableBioDataParameters}" 
                         var="bioDatParam" 
                         itemLabel="#{bioDatParam}" 
                         itemValue="#{bioDatParam}" />
        </p:selectManyCheckbox>
      </p:tab>
    </p:accordionPanel>

    <p:commandButton action="#{listManagerController.performUpdateColumns()}" 
                     value="Update" 
                     icon="ui-icon-refresh" 
                     oncomplete="PF('activeListTblWidgetVar').clearFilters()"/>

    <p:spacer height="20" width="100%"/>

    <p:dataTable  id="activeListTbl"
                  widgetVar="activeListTblWidgetVar"
                  var="listMember" 
                  value="#{listManagerController.activeList.cmpdListMembers}" 
                  rows="50"                        
                  paginator="true"
                  resizableColumns="true"
                  paginatorTemplate="On Page {CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown} Rows Per Page"  
                  rowsPerPageTemplate="50,100,250,500"
                  selection="#{listContentController.selectedActiveListMembers}"
                  rowKey="#{listMember.id}"                              
                  sortMode="multiple">  

      <p:ajax event="rowSelect" listener="#{listContentController.onRowSelect}" />
      <p:ajax event="rowUnselect" listener="#{listContentController.onRowDeSelect}" />

      <f:facet name="header">                
        <h:outputText value="List #{listManagerController.activeList.listName} with #{fn:length(listManagerController.activeList.cmpdListMembers)} Members"/>    
      </f:facet>

      <p:columnGroup type="header">
        <p:row>
          <p:column rowspan="2" headerText="All" />
          <p:column rowspan="2" headerText="Comment" />
          <p:column rowspan="2" headerText="Structure" />
          <p:column rendered="#{!empty listManagerController.selectedCmpdParameters}"
                    colspan="#{fn:length(listManagerController.selectedCmpdParameters)}" 
                    headerText="Cmpd" />
          <p:column rendered="#{!empty listManagerController.selectedStructureParameters}"
                    colspan="#{fn:length(listManagerController.selectedStructureParameters)}" 
                    headerText="Structure" />
          <p:column rendered="#{!empty listManagerController.selectedPChemParameters}"
                    colspan="#{fn:length(listManagerController.selectedPChemParameters)}" 
                    headerText="pChem" />
          <p:column rendered="#{!empty listManagerController.selectedBioDataParameters}"
                    colspan="#{fn:length(listManagerController.selectedBioDataParameters)}" 
                    headerText="BioData" />
        </p:row>
        <p:row>
          
          <ui:repeat value="#{listManagerController.selectedCmpdParameters}" var="scp">
            <p:column headerText="#{scp}" />
          </ui:repeat>

          
          <ui:repeat value="#{listManagerController.selectedStructureParameters}" var="ssp">
            <p:column headerText="#{ssp}" />
          </ui:repeat>

          
          <ui:repeat value="#{listManagerController.selectedPChemParameters}" var="spcp">
            <p:column headerText="#{spcp}" />
          </ui:repeat>

          <ui:repeat value="#{listManagerController.selectedBioDataParameters}" var="sbdp">
            <p:column headerText="#{sbdp}" />
          </ui:repeat>
          
        </p:row>
      </p:columnGroup>

      <p:column headerText="All"
                resizable="true" selectionMode="multiple" 
                style="width:4%" 
                exportable="false"/>

      <p:column headerText="Comment" resizable="true">                                
        <h:outputText value="#{listMember.listMemberComment}"/>
      </p:column>   

      <p:column headerText="Click for details" resizable="true">

        <p:commandLink update=":datasystemForm:ListMemberDetailsDialogPanel" oncomplete="PF('listMemberDetailDlg').show();" title="View Detail">
          <h:graphicImage alt="png-structure-with-highlighted-substructure-image"
                          width="75" height="75"
                          url='/StructureServlet?structureDim=75&amp;title=#{listMember.cmpd.name}&amp;smiles=#{applicationScopeBean.urlEncode(listMember.cmpd.parentFragment.cmpdFragmentStructure.canSmi)}&amp;querySmiles=#{applicationScopeBean.urlEncode(listManagerController.activeList.anchorSmiles)}'>              
          </h:graphicImage>
          <f:setPropertyActionListener value="#{listMember}"   
                                       target="#{listManagerController.selectedActiveListMember}" />  
        </p:commandLink>

        <h:graphicImage style="display: none;" alt="png-structure-with-highlighted-substructure-image"
                        width="200" height="200"
                        id="structureImg"
                        url='/StructureServlet?structureDim=200&amp;title=#{listMember.cmpd.name}&amp;smiles=#{applicationScopeBean.urlEncode(listMember.cmpd.parentFragment.cmpdFragmentStructure.canSmi)}&amp;querySmiles=#{applicationScopeBean.urlEncode(listManagerController.activeList.anchorSmiles)}'>              
        </h:graphicImage>

      </p:column>      

      <c:set var="cmpd" value="#{listMember.cmpd}" />

      <p:columns resizable="true"  
                 value="#{listManagerController.cmpdColumns}" 
                 var="column" 
                 columnIndexVar="colIndex" 
                 sortBy="#{cmpd[column.property]}" 
                 filterBy="#{cmpd[column.property]}">
        <f:facet name="header">
          <h:outputText value="#{column.header}" />
        </f:facet>
        <h:outputText value="#{cmpd[column.property]}" />
      </p:columns>

      <c:set var="strc" value="#{listMember.cmpd.parentFragment.cmpdFragmentStructure}" />
      
      <p:columns resizable="true" 
                 value="#{listManagerController.structureColumns}" 
                 var="column" 
                 columnIndexVar="colIndex" 
                 sortBy="#{strc[column.property]}" 
                 filterBy="#{strc[column.property]}">
        <f:facet name="header">
          <h:outputText value="#{column.header}" />
        </f:facet>
        <h:outputText value="#{strc[column.property]}" />
      </p:columns>

      <c:set var="physchem" value="#{listMember.cmpd.parentFragment.cmpdFragmentPChem}" />
      
      <p:columns resizable="true" 
                 value="#{listManagerController.physChemColumns}" 
                 var="column" 
                 columnIndexVar="colIndex" 
                 sortBy="#{physchem[column.property]}" 
                 filterBy="#{physchem[column.property]}">
        <f:facet name="header">
          <h:outputText value="#{column.header}" />
        </f:facet>
        <h:outputText value="#{physchem[column.property]}" />
      </p:columns>

      <c:set var="biodat" value="#{listMember.cmpd.cmpdBioAssay}" />
      
      <p:columns resizable="true" 
                 value="#{listManagerController.biodataColumns}" 
                 var="column" 
                 columnIndexVar="colIndex" 
                 sortBy="#{biodat[column.property]}" 
                 filterBy="#{biodat[column.property]}">
        <f:facet name="header">
          <h:outputText value="#{column.header}" />
        </f:facet>
        <h:outputText value="#{biodat[column.property]}" />
      </p:columns>

    </p:dataTable>

  </ui:define>

</ui:composition>
